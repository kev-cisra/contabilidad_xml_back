// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

model usuario {
  id        BigInt    @id @default(autoincrement())
  uuid      String    @default(uuid()) @unique
  email     String    @unique(map: "Usuario_email_key") @db.VarChar(80)
  password  String    @db.VarChar(255)
  nombre    String?   @db.VarChar(150)
  createdAt DateTime  @default(now())
  updatedAt DateTime
  deletedAt DateTime?

  tokens    token[]
  usuarioRoles usuarioRole[]
  usuarioModulos usuarioModulo[]
}

enum TokenType {
  api
  refresh
  reset_password
  verify_email
  magic_login
  session
  oauth_access
}

model token {
  id       BigInt    @id @default(autoincrement())
  uuid     String    @default(uuid()) @unique
  secretHash String    @db.VarChar(255)
  type       TokenType @default(session)
  revokedAt  DateTime?
  expiresAt  DateTime
  deviceId   String?   @db.VarChar(255)
  usuarioId  BigInt
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  usuario usuario @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId], map: "Token_usuarioId_fkey")
}

model role {
  id        BigInt    @id @default(autoincrement())
  uuid      String    @default(uuid()) @unique
  name      String    @unique @db.VarChar(100)
  description String?   @db.VarChar(255)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  rolePermissions rolePermission[]
  usuarioRoles usuarioRole[]
}

model permission {
  id        BigInt    @id @default(autoincrement())
  uuid      String    @default(uuid()) @unique
  name      String    @unique @db.VarChar(100)
  description String?   @db.VarChar(255)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  rolePermissions rolePermission[]

  @@index ([name], map: "Permission_name_idx")
}

model rolePermission {
  roleId       BigInt
  permissionId BigInt
  assignedAt   DateTime @default(now())
  deletedAt    DateTime?

  role       role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model usuarioRole {
  usuarioId BigInt
  roleId    BigInt
  assignedAt DateTime @default(now())
  deletedAt  DateTime?

  usuario usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  role    role    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([usuarioId, roleId])
  @@index([usuarioId])
  @@index([roleId])
}

model modulos {
  id        BigInt    @id @default(autoincrement())
  uuid      String    @default(uuid()) @unique
  name      String    @unique @db.VarChar(100)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  usuarioModulos usuarioModulo[]
}

model usuarioModulo {
  usuarioId BigInt
  moduloId   BigInt
  assignedAt DateTime @default(now())
  deletedAt  DateTime?

  usuario usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  modulos modulos @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  @@id([usuarioId, moduloId])
  @@index([usuarioId])
  @@index([moduloId])
}